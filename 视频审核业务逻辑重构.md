# 视频审核业务逻辑（按流量池队列）重构说明

## 背景与目标

- 视频审核不区分一审/二审，采用“流量池分级 + 单阶段审核”模式。
- 所有视频首先进入 `10万（100k）` 流量池队列；经审核可流转至 `100万（1m）`，再由 `100万` 达标的视频进入 `1000万（10m）` 专属确认队列。
- 队列访问完全依赖现有“键值对权限管理”，不新增额外访问控制层；`10m` 队列仅授予质检员相关权限键。
- 简化视频审核标签体系：仅保留“审核决定 + 审核理由 + 审核标签（最多选 3）”。

## 队列定义与流转规则（修正）

- 队列标识：
  - `video:queue:100k`（入口队列，所有新视频先入此队列）
  - `video:queue:1m`（由 100k 审核达标后推送进入）
  - `video:queue:10m`（由 1m 审核达标后推送进入，仅质检员确认）
- 100k 队列审核决定（三选一）：
  - 推送 `100万流量池`：将该视频对应任务压入 `video:queue:1m`
  - 自然流量池：不做任何队列操作（视频自然增长，不再进入更高队列）
  - 违规下架：将视频标记下架并终止后续队列流转
- 1m 队列审核决定（三选一）：
  - 推送 `1000万流量池（待确认）`：压入 `video:queue:10m`，等待质检确认
  - 自然流量池：不做队列操作
  - 违规下架：标记下架
- 10m 队列审核决定（质检确认，三选一）：
  - 确认推送 `1000万流量池`：正式确认结果（可记录统计与曝光策略），结束队列流转
  - 回退至自然流量池：不再进行更高队列操作
  - 违规下架：标记下架
- 相关代码参考：
  - Redis 客户端初始化：`pkg/redis/redis.go:16`
  - 领取/锁/过期释放示例：`internal/services/video_service.go:205-223`、`internal/services/video_service.go:359-387`

## 权限映射（沿用键值对权限）

- 直接使用现有权限中间件：`internal/middleware/permission.go:25` → `RequirePermission`
- 建议权限键（示例命名，按队列与动作分组）：
  - 领取：`queue.video.100k.claim`、`queue.video.1m.claim`、`queue.video.10m.claim`
  - 提交：`queue.video.100k.submit`、`queue.video.1m.submit`、`queue.video.10m.submit`
  - 归还：`queue.video.100k.return`、`queue.video.1m.return`、`queue.video.10m.return`
  - 我的任务：`queue.video.100k.my`、`queue.video.1m.my`、`queue.video.10m.my`
- 权限分配建议：
  - 普通审核员：授予 `100k` 与 `1m` 队列相关权限键
  - 质检员：额外授予 `10m` 队列相关权限键
- 路由绑定位置：`cmd/api/main.go`（参考现有 `RequirePermission` 用法）。

## Redis 键规范

- 队列（List）：`video:queue:{pool}`（`{pool}` ∈ `100k|1m|10m`）
- 领取跟踪（Set）：`video:claimed:{user_id}:{pool}`
- 任务锁（KV，TTL）：`video:lock:{task_id}`（值为 `user_id`，TTL=配置 `TaskTimeoutMinutes`）
- 统计（Hash/Counter）：保留 `video:stats:*`，可选增加队列维度 `video:stats:queue:{pool}:{date}`
- 参考实现：`internal/services/video_service.go:205-223`、`internal/services/video_service.go:359-387`

## 审核流程（单阶段、按队列）

- 领取：`POST /api/video/{pool}/tasks/claim`（参数：`count`，权限：`queue.video.{pool}.claim`）
- 我的任务：`GET /api/video/{pool}/tasks/my`（权限：`queue.video.{pool}.my`）
- 提交：`POST /api/video/{pool}/tasks/submit`（支持批量，权限：`queue.video.{pool}.submit`）
  - 提交后的流转依据“审核决定”执行相应队列操作（见上文流转规则）
- 归还：`POST /api/video/{pool}/tasks/return`（权限：`queue.video.{pool}.return`）
- 过期释放：保留现有超时归还与重置逻辑

## 审核字段与标签体系（简化）

- 审核字段：
  - 审核决定：枚举（`push_next_pool` | `natural_pool` | `remove_violation`）
  - 审核理由：文本（必填）
  - 审核标签：多选，最多 3 项（从配置集合中选择）
- 标签配置：
  - 在 `internal/models/models.go` 的标签模型上扩展 `scope=video`，可选 `queue_id`
  - 数据访问增加 `FindByScopeAndQueueID(scope, queueID)` 以按队列返回标签集合
  - 管理端支持按 `scope=video` 与队列维度配置标签；审核端强制多选上限为 3
- 现有质量维度打分（内容/技术/合规/传播潜力）取消，不再出现在审核表单与结果结构中

## API 设计调整（示例）

- 路由（建议）：
  - `POST /api/video/{pool}/tasks/claim` → `RequirePermission("queue.video.{pool}.claim")`
  - `GET  /api/video/{pool}/tasks/my` → `RequirePermission("queue.video.{pool}.my")`
  - `POST /api/video/{pool}/tasks/submit` → `RequirePermission("queue.video.{pool}.submit")`
  - `POST /api/video/{pool}/tasks/submit-batch` → 同上
  - `POST /api/video/{pool}/tasks/return` → `RequirePermission("queue.video.{pool}.return")`
- 说明：
  - 保留现有路由以兼容历史流程；新增单阶段视频路由逐步切换

## 统计与监控

- 队列统计整合到统一视图（参考 `migrations/005_unified_queue_stats.sql`），新增队列维度
- 管理端 `QueueManage.vue` 展示三类队列的待审/进行中/完成统计与趋势

## 数据迁移建议

- 历史在途任务：
  - 未领取/已归还任务统一入 `100k` 队列作为入口；按新规则逐级流转
  - 进行中的任务按原路由完成，避免中断；新任务走单阶段队列
- 表结构：
  - 保留现有表以兼容；新增或复用“视频单阶段任务/结果”结构
  - 标签表增加 `scope`/`queue_id`/`is_simple` 字段迁移

## 验收标准

- 未授权用户访问任意队列接口返回权限不足（由键值对权限中间件保障）
- 三类队列的领取/提交/归还/过期释放均正常，Redis 与数据库一致
- 审核页面仅展示“审核决定/理由/标签（≤3）”；提交能正确驱动队列流转与统计
- 管理端队列与标签配置功能完整，统计数据包含三类队列维度

## 代码参考位置

- 权限中间件：`internal/middleware/permission.go:25`
- 路由绑定示例：`cmd/api/main.go:148`
- 视频服务流程（现状）：`internal/services/video_service.go:178`、`internal/services/video_service.go:233`、`internal/services/video_service.go:359`
- Redis 客户端：`pkg/redis/redis.go:16`
- 标签管理入口：`internal/repository/tag_repo.go`、`frontend/src/views/admin/TagManage.vue`

> 注：本文档为业务逻辑重构说明，后续将按此方案推进接口、服务层与前端的具体改造，保持对现有权限体系的完全兼容。
 是的，后续可以让 AI 接着 VIDEO_QUEUE_MIGRATION_GUIDE.md 文档继续完成后端收尾工作：
  - 等 Supabase 维护完成后应用数据库 migration
  - 配置用户权限
  - 创建入口队列任务
  - 运行安全检查

  2. 关于前端修改

  ✅ 已全部完成！前端现在完全支持新的视频队列系统。

  ---
  🎯 前端完成的工作

  1️⃣ 新建文件（2个）

  frontend/src/api/videoQueue.ts - API 服务层

  - 完整的 TypeScript 类型定义
  - 8个 API 函数（领取/提交/归还/标签/统计等）
  - 支持三个队列的动态路由

  frontend/src/views/reviewer/VideoQueueReviewDashboard.vue - 核心审核界面

  550行代码，功能包括：
  - 🎛️ 队列切换器（Segmented 组件，支持100k/1m/10m）
  - 📊 统计卡片（当前队列/待审任务/今日完成）
  - 🎬 视频播放器（按需加载URL，支持完整控制）
  - 📝 简化审核表单：
    - 审核决定（3选1，图标化展示）
    - 审核标签（最多3个，按类别分组）
    - 审核理由（必填，500字限制）
  - ⚡ 批量操作（领取/归还/批量提交）
  - ✨ 实时表单验证和进度提示

  2️⃣ 修改文件（2个）

  frontend/src/router/index.ts

  - 新增路由：/reviewer/video-queue-review
  - 兼容旧系统路由

  frontend/src/components/QueueList.vue

  - 修改 handleAnnotate() 函数
  - 智能识别视频队列（关键词：视频/流量池）
  - 自动跳转到新的审核工作台

  3️⃣ 新建文档（1个）

  FRONTEND_VIDEO_QUEUE_GUIDE.md - 完整使用指南

  包含：
  - 功能说明
  - 使用流程
  - 审核标签详解
  - API 接口文档
  - 常见问题
  - 开发说明

  ---
  🚀 新系统特性

  核心改进

  1. 三队列分级 - 100k → 1m → 10m 流量池
  2. 简化审核 - 决定 + 理由 + 标签（最多3个）
  3. 智能流转 - 根据决定自动创建下级任务
  4. 权限隔离 - 10m队列仅质检员可访问
  5. 批量操作 - 提高审核效率

  用户体验

  - ✅ 界面简洁明了
  - ✅ 队列切换流畅
  - ✅ 视频按需加载
  - ✅ 实时表单验证
  - ✅ 操作反馈及时

  ---
  📝 使用方法

  审核员操作流程

  1. 登录系统 → 进入"队列列表"
  2. 找到视频审核队列 → 点击"标注"
  3. 选择队列（100k/1m/10m）
  4. 领取任务（输入数量 1-50）
  5. 观看视频 → 填写审核
     - 选择决定（推送/自然/违规）
     - 选择标签（1-3个）
     - 填写理由（必填）
  6. 提交审核（单个或批量）

  队列决定含义

  100k队列:
  - 推送到下一流量池 → 创建1m任务
  - 自然流量池 → 停止推广
  - 违规下架 → 视频下架

  1m队列:
  - 推送到下一流量池 → 创建10m任务（待质检）
  - 自然流量池 → 停止推广
  - 违规下架 → 视频下架

  10m队列（质检）:
  - 推送到下一流量池 → 确认推送1000万流量池
  - 自然流量池 → 回退
  - 违规下架 → 视频下架

  ---
  🔧 待完成工作（仅后端）

  根据 VIDEO_QUEUE_MIGRATION_GUIDE.md，还需完成：

  1. 应用数据库迁移（等Supabase维护完成）

  -- 执行 migrations/006_video_queue_pool_system.sql

  2. 配置权限

  -- 为普通审核员授予 100k 和 1m 权限
  -- 为质检员额外授予 10m 权限

  3. 创建入口任务

  -- 为现有视频创建 100k 队列任务

  4. 运行安全检查

  # 使用 Supabase MCP 工具检查安全配置

  ---
  📦 文件清单

  后端文件（已完成）

  - migrations/006_video_queue_pool_system.sql - 数据库迁移
  - internal/models/models.go - 模型定义（+90行）
  - internal/repository/video_queue_repo.go - 数据访问层（新建）
  - internal/services/video_queue_service.go - 业务逻辑层（新建）
  - internal/handlers/video_queue_handler.go - HTTP处理器（新建）
  - cmd/api/main.go - 路由配置（已修改）
  - VIDEO_QUEUE_MIGRATION_GUIDE.md - 后端迁移指南

  前端文件（✅ 已完成）

  - frontend/src/api/videoQueue.ts - API服务（新建）
  - frontend/src/views/reviewer/VideoQueueReviewDashboard.vue - 审核界面（新建）
  - frontend/src/router/index.ts - 路由配置（已修改）
  - frontend/src/components/QueueList.vue - 队列列表（已修改）
  - FRONTEND_VIDEO_QUEUE_GUIDE.md - 前端使用指南

  ---
  🎓 下一步操作

  1. 测试前端 (可选，需要后端支持)：
  cd frontend
  npm install
  npm run dev
  # 访问 http://localhost:5173/reviewer/video-queue-review

  2. 等待后端迁移完成：
    - Supabase 维护完成后应用 migration
    - 配置权限
    - 启动后端服务
  3. 完整测试：
    - 测试三个队列的切换
    - 测试审核提交和流转
    - 验证权限控制

  ---
  总结：✅ 前端已 100% 完成！后端只需等 Supabase 维护完成后执行几步配置操作即可启用新系统！🚀
